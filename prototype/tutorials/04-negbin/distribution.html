<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GLM Tutorial: Distribution (Negative Binomial)</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #f8f9fa;
      color: #333;
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      background: linear-gradient(135deg, #d35400 0%, #e67e22 100%);
      color: white;
      padding: 20px;
      margin-bottom: 20px;
    }

    header h1 {
      font-size: 1.5em;
      margin-bottom: 5px;
    }

    header p {
      opacity: 0.9;
      font-size: 0.95em;
    }

    /* Progress bar */
    .progress-container {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .progress-bar {
      display: flex;
      justify-content: space-between;
      position: relative;
      margin-bottom: 15px;
    }

    .progress-bar::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 3px;
      background: #e0e0e0;
      transform: translateY(-50%);
      z-index: 1;
    }

    .progress-fill {
      position: absolute;
      top: 50%;
      left: 0;
      height: 3px;
      background: #d35400;
      transform: translateY(-50%);
      z-index: 2;
      width: 40%;
    }

    .step-dot {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #e0e0e0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.85em;
      z-index: 3;
    }

    .step-dot.completed {
      background: #d35400;
      color: white;
    }

    .step-dot.current {
      background: #e67e22;
      color: white;
      transform: scale(1.2);
      box-shadow: 0 0 0 4px rgba(230, 126, 34, 0.3);
    }

    /* Warning panel - overdispersion reminder */
    .warning-panel {
      background: #fdedec;
      border-left: 4px solid #e74c3c;
      padding: 15px 20px;
      border-radius: 0 8px 8px 0;
      margin-bottom: 20px;
    }

    .warning-panel h4 {
      color: #922b21;
      margin-bottom: 8px;
    }

    .warning-panel p {
      color: #922b21;
      font-size: 0.9em;
    }

    .warning-panel .stat {
      background: rgba(255,255,255,0.7);
      padding: 2px 8px;
      border-radius: 4px;
      font-weight: 600;
      font-family: monospace;
    }

    /* Instruction panel */
    .instruction-panel {
      background: #fef5e7;
      border-left: 4px solid #e67e22;
      padding: 15px 20px;
      border-radius: 0 8px 8px 0;
      margin-bottom: 20px;
    }

    .instruction-panel h3 {
      color: #d35400;
      margin-bottom: 8px;
    }

    /* Distribution options */
    .dist-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .dist-card {
      background: white;
      border: 3px solid #dee2e6;
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .dist-card:hover {
      border-color: #e67e22;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .dist-card.selected {
      border-color: #27ae60;
      background: #eafaf1;
    }

    .dist-card.wrong {
      border-color: #e74c3c;
      background: #fdedec;
      animation: shake 0.3s;
    }

    .dist-card.semi-correct {
      border-color: #f39c12;
      background: #fef9e7;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }

    .dist-name {
      font-size: 1.3em;
      font-weight: 600;
      margin-bottom: 8px;
      color: #2c3e50;
    }

    .dist-formula {
      font-family: 'Times New Roman', serif;
      font-size: 1.1em;
      background: #f8f9fa;
      padding: 8px 12px;
      border-radius: 4px;
      margin-bottom: 10px;
      display: inline-block;
    }

    .dist-variance {
      font-size: 0.9em;
      color: #666;
      margin-bottom: 8px;
    }

    .dist-desc {
      color: #666;
      font-size: 0.9em;
    }

    /* Dialog box */
    .dialog-box {
      display: none;
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-top: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }

    .dialog-box.show {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .dialog-box.correct {
      border-left: 5px solid #27ae60;
    }

    .dialog-box.wrong {
      border-left: 5px solid #e74c3c;
    }

    .dialog-box.semi-correct {
      border-left: 5px solid #f39c12;
    }

    .dialog-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }

    .dialog-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5em;
    }

    .dialog-icon.correct { background: #d4edda; }
    .dialog-icon.wrong { background: #f8d7da; }
    .dialog-icon.semi-correct { background: #fff3cd; }

    .dialog-title {
      font-size: 1.2em;
      font-weight: 600;
    }

    .dialog-content {
      color: #555;
      line-height: 1.7;
    }

    .dialog-content ul {
      margin: 10px 0 10px 20px;
    }

    .dialog-content li {
      margin: 5px 0;
    }

    .highlight-box {
      background: #fef5e7;
      border-radius: 6px;
      padding: 12px 15px;
      margin-top: 15px;
      font-size: 0.9em;
    }

    .highlight-box.success {
      background: #d4edda;
    }

    .comparison-table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
      font-size: 0.9em;
    }

    .comparison-table th, .comparison-table td {
      padding: 8px 12px;
      border: 1px solid #dee2e6;
      text-align: left;
    }

    .comparison-table th {
      background: #f8f9fa;
      font-weight: 600;
    }

    .comparison-table .bad {
      background: #fdedec;
      color: #922b21;
    }

    .comparison-table .good {
      background: #d4edda;
      color: #155724;
    }

    /* Navigation */
    .nav-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #dee2e6;
    }

    .btn {
      padding: 10px 20px;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      display: inline-block;
    }

    .btn-primary {
      background: #d35400;
      color: white;
      border: none;
    }

    .btn-primary:hover:not(:disabled) {
      background: #ba4a00;
    }

    .btn-primary:disabled {
      background: #bdc3c7;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: #ecf0f1;
      color: #666;
      border: none;
    }

    .btn-secondary:hover {
      background: #bdc3c7;
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>Tutorial 4: Handling Overdispersion</h1>
      <p>Step 3: Choose the Distribution Family</p>
    </div>
  </header>

  <div class="container">
    <!-- Progress -->
    <div class="progress-container">
      <div class="progress-bar">
        <div class="progress-fill"></div>
        <div class="step-dot completed">&#10003;</div>
        <div class="step-dot completed">&#10003;</div>
        <div class="step-dot current">3</div>
        <div class="step-dot">4</div>
        <div class="step-dot">5</div>
        <div class="step-dot">6</div>
      </div>
    </div>

    <!-- Warning: Overdispersion reminder -->
    <div class="warning-panel">
      <h4>Remember: Our Data is Overdispersed!</h4>
      <p>
        From Tutorial 3, we found <span class="stat">Deviance/df = 524.1</span> (should be ~1).
        This means the variance in our data is <strong>524 times larger</strong> than Poisson assumes!
        The consequence: Poisson gives standard errors that are far too small.
      </p>
    </div>

    <!-- Instruction -->
    <div class="instruction-panel">
      <h3>Step 3: Select the Distribution Family</h3>
      <p>Which distribution properly models overdispersed count data?</p>
      <p style="font-size: 0.9em; color: #666;">
        <strong>Hint:</strong> We need a distribution where Variance > Mean is allowed.
      </p>
    </div>

    <!-- Distribution options -->
    <div class="dist-options">
      <div class="dist-card" data-dist="negbin">
        <div class="dist-name">Negative Binomial</div>
        <div class="dist-formula">Y ~ NegBin(&mu;, &theta;)</div>
        <p class="dist-variance"><strong>Variance:</strong> &mu; + &mu;&sup2;/&theta;</p>
        <p class="dist-desc">Counts with extra dispersion parameter &theta;. Allows Var > Mean.</p>
      </div>

      <div class="dist-card" data-dist="poisson">
        <div class="dist-name">Poisson</div>
        <div class="dist-formula">Y ~ Poisson(&mu;)</div>
        <p class="dist-variance"><strong>Variance:</strong> &mu; (equals mean)</p>
        <p class="dist-desc">Standard count distribution. Assumes Variance = Mean.</p>
      </div>

      <div class="dist-card" data-dist="quasipoisson">
        <div class="dist-name">Quasi-Poisson</div>
        <div class="dist-formula">Y ~ QuasiPoisson(&mu;, &phi;)</div>
        <p class="dist-variance"><strong>Variance:</strong> &phi; &times; &mu;</p>
        <p class="dist-desc">Quick fix - inflates SEs by &phi;. Not a proper probability model.</p>
      </div>

      <div class="dist-card" data-dist="gaussian">
        <div class="dist-name">Gaussian</div>
        <div class="dist-formula">Y ~ Normal(&mu;, &sigma;&sup2;)</div>
        <p class="dist-variance"><strong>Variance:</strong> &sigma;&sup2; (constant)</p>
        <p class="dist-desc">For continuous outcomes. Allows negative values.</p>
      </div>
    </div>

    <!-- Dialog box -->
    <div class="dialog-box" id="dialogBox">
      <div class="dialog-header">
        <div class="dialog-icon" id="dialogIcon"></div>
        <div class="dialog-title" id="dialogTitle"></div>
      </div>
      <div class="dialog-content" id="dialogContent"></div>
    </div>

    <!-- Navigation -->
    <div class="nav-buttons">
      <a href="link.html" class="btn btn-secondary">&larr; Back to Link Function</a>
      <button class="btn btn-primary" id="continueBtn" disabled>Continue to Fitting &rarr;</button>
    </div>
  </div>

  <script>
    const dialogs = {
      negbin: {
        type: 'correct',
        icon: '&#10003;',
        title: 'Correct! Negative Binomial handles overdispersion.',
        content: `
          <p>The <strong>Negative Binomial</strong> distribution is perfect for overdispersed count data:</p>
          <ul>
            <li><strong>Variance = &mu; + &mu;&sup2;/&theta;:</strong> Always larger than the mean</li>
            <li><strong>Dispersion parameter &theta;:</strong> Estimated from data, controls extra variance</li>
            <li><strong>Proper probability model:</strong> Unlike quasi-Poisson, has a full likelihood</li>
            <li><strong>Reduces to Poisson:</strong> When &theta; &rarr; &infin;, NegBin &rarr; Poisson</li>
          </ul>
          <table class="comparison-table">
            <tr>
              <th>Metric</th>
              <th>Poisson (Tutorial 3)</th>
              <th>Negative Binomial</th>
            </tr>
            <tr>
              <td>Deviance/df</td>
              <td class="bad">524.1</td>
              <td class="good">1.04</td>
            </tr>
            <tr>
              <td>AIC</td>
              <td class="bad">387,415</td>
              <td class="good">12,840</td>
            </tr>
            <tr>
              <td>SE(temp)</td>
              <td class="bad">0.0032</td>
              <td class="good">0.0813</td>
            </tr>
          </table>
          <div class="highlight-box success">
            <strong>Key insight:</strong> The standard errors are ~25x larger with Negative Binomial.
            This gives honest uncertainty estimates - Poisson was massively overconfident!
          </div>
        `
      },
      poisson: {
        type: 'wrong',
        icon: '&#10007;',
        title: 'We already know Poisson doesn\'t fit!',
        content: `
          <p>We tried Poisson in <strong>Tutorial 3</strong> and discovered severe problems:</p>
          <ul>
            <li><strong>Deviance/df = 524:</strong> Should be ~1 for a good fit</li>
            <li><strong>Variance = Mean assumption:</strong> Our data violates this drastically</li>
            <li><strong>Underestimated SEs:</strong> p-values are unreliable (too optimistic)</li>
          </ul>
          <div class="highlight-box">
            <strong>The overdispersion problem:</strong> Poisson assumes Var(Y) = &mu;.
            But our bike rental counts have far more variability than that.
            Days with similar predicted counts can have wildly different actual counts.
            <br><br>
            Try selecting <strong>Negative Binomial</strong> to properly model this extra variance.
          </div>
        `
      },
      quasipoisson: {
        type: 'semi-correct',
        icon: '~',
        title: 'Quick fix, but not ideal.',
        content: `
          <p>The <strong>Quasi-Poisson</strong> is a pragmatic workaround:</p>
          <ul>
            <li><strong>Inflates SEs:</strong> Multiplies by &radic;&phi; to account for overdispersion</li>
            <li><strong>Same coefficients:</strong> Point estimates identical to Poisson</li>
            <li><strong>No proper likelihood:</strong> Can't compute AIC or do likelihood ratio tests</li>
          </ul>
          <div class="highlight-box">
            <strong>When to use Quasi-Poisson:</strong>
            <ul>
              <li>Quick exploratory analysis</li>
              <li>When you just need corrected SEs</li>
              <li>Teaching/simple demonstrations</li>
            </ul>
            <strong>Why Negative Binomial is better:</strong>
            <ul>
              <li>Proper probability model with full likelihood</li>
              <li>Can compute AIC, do model selection</li>
              <li>More flexible variance structure: Var = &mu; + &mu;&sup2;/&theta;</li>
            </ul>
            Try selecting <strong>Negative Binomial</strong> for the proper solution.
          </div>
        `
      },
      gaussian: {
        type: 'wrong',
        icon: '&#10007;',
        title: 'Wrong data type - counts, not continuous!',
        content: `
          <p>The <strong>Gaussian</strong> distribution is wrong for several reasons:</p>
          <ul>
            <li><strong>Allows negative values:</strong> You can't have -100 bike rentals</li>
            <li><strong>Continuous, not discrete:</strong> Counts are integers (0, 1, 2, ...)</li>
            <li><strong>Constant variance:</strong> Assumes same spread at all levels of &mu;</li>
          </ul>
          <div class="highlight-box">
            <strong>When to use Gaussian:</strong> Tutorial 1 (heart rate) was continuous and
            could theoretically take any value. Bike rental counts are fundamentally different.
            <br><br>
            Try selecting <strong>Negative Binomial</strong> - it's designed for overdispersed counts.
          </div>
        `
      }
    };

    const cards = document.querySelectorAll('.dist-card');
    const dialogBox = document.getElementById('dialogBox');
    const continueBtn = document.getElementById('continueBtn');

    cards.forEach(card => {
      card.addEventListener('click', () => {
        const dist = card.dataset.dist;
        const dialog = dialogs[dist];

        // Reset all cards
        cards.forEach(c => c.classList.remove('selected', 'wrong', 'semi-correct'));

        // Style the clicked card
        if (dialog.type === 'correct') {
          card.classList.add('selected');
          continueBtn.disabled = false;
        } else if (dialog.type === 'semi-correct') {
          card.classList.add('semi-correct');
          continueBtn.disabled = true;
        } else {
          card.classList.add('wrong');
          continueBtn.disabled = true;
        }

        // Show dialog
        dialogBox.className = `dialog-box show ${dialog.type}`;
        document.getElementById('dialogIcon').className = `dialog-icon ${dialog.type}`;
        document.getElementById('dialogIcon').innerHTML = dialog.icon;
        document.getElementById('dialogTitle').textContent = dialog.title;
        document.getElementById('dialogContent').innerHTML = dialog.content;
      });
    });

    continueBtn.addEventListener('click', () => {
      window.location.href = 'fitting.html';
    });

    // Initialize KaTeX
    document.addEventListener('DOMContentLoaded', function() {
      if (typeof renderMathInElement !== 'undefined') {
        renderMathInElement(document.body, {
          delimiters: [
            {left: '$$', right: '$$', display: true},
            {left: '$', right: '$', display: false}
          ]
        });
      }
    });
  </script>
</body>
</html>
