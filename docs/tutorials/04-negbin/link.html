<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GLM Tutorial: Link Function (Negative Binomial)</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #f8f9fa;
      color: #333;
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      background: linear-gradient(135deg, #d35400 0%, #e67e22 100%);
      color: white;
      padding: 20px;
      margin-bottom: 20px;
    }

    header h1 {
      font-size: 1.5em;
      margin-bottom: 5px;
    }

    header p {
      opacity: 0.9;
      font-size: 0.95em;
    }

    /* Progress bar */
    .progress-container {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .progress-bar {
      display: flex;
      justify-content: space-between;
      position: relative;
      margin-bottom: 15px;
    }

    .progress-bar::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 3px;
      background: #e0e0e0;
      transform: translateY(-50%);
      z-index: 1;
    }

    .progress-fill {
      position: absolute;
      top: 50%;
      left: 0;
      height: 3px;
      background: #d35400;
      transform: translateY(-50%);
      z-index: 2;
      width: 20%;
    }

    .step-dot {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #e0e0e0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.85em;
      z-index: 3;
    }

    .step-dot.completed {
      background: #d35400;
      color: white;
    }

    .step-dot.current {
      background: #e67e22;
      color: white;
      transform: scale(1.2);
      box-shadow: 0 0 0 4px rgba(230, 126, 34, 0.3);
    }

    /* Context panel */
    .context-panel {
      background: #e8f8f5;
      border-left: 4px solid #1abc9c;
      padding: 15px 20px;
      border-radius: 0 8px 8px 0;
      margin-bottom: 20px;
    }

    .context-panel h4 {
      color: #117a65;
      margin-bottom: 8px;
    }

    .context-panel p {
      color: #117a65;
      font-size: 0.9em;
    }

    /* Instruction panel */
    .instruction-panel {
      background: #fef5e7;
      border-left: 4px solid #e67e22;
      padding: 15px 20px;
      border-radius: 0 8px 8px 0;
      margin-bottom: 20px;
    }

    .instruction-panel h3 {
      color: #d35400;
      margin-bottom: 8px;
    }

    /* Link options */
    .link-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .link-card {
      background: white;
      border: 3px solid #dee2e6;
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .link-card:hover:not(.dimmed) {
      border-color: #e67e22;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .link-card.dimmed {
      opacity: 0.4;
      filter: grayscale(40%);
      pointer-events: none;
    }

    .link-card.selected-correct {
      border-color: #27ae60;
      background: #eafaf1;
    }

    .link-card.selected-wrong {
      border-color: #e74c3c;
      background: #fdedec;
      animation: shake 0.3s;
    }

    .link-card.selected-semi {
      border-color: #f39c12;
      background: #fef9e7;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }

    .link-name {
      font-size: 1.3em;
      font-weight: 600;
      margin-bottom: 8px;
      color: #2c3e50;
    }

    .link-formula {
      font-family: 'Times New Roman', serif;
      font-size: 1.1em;
      background: #f8f9fa;
      padding: 8px 12px;
      border-radius: 4px;
      margin-bottom: 10px;
      display: inline-block;
    }

    .link-desc {
      color: #666;
      font-size: 0.9em;
    }

    /* Dialog overlay (modal) */
    .dialog-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 100;
      align-items: center;
      justify-content: center;
      overflow-y: auto;
    }

    .dialog-overlay.show {
      display: flex;
    }

    .dialog {
      background: white;
      border-radius: 12px;
      padding: 25px;
      max-width: 550px;
      margin: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      max-height: 90vh;
      overflow-y: auto;
    }

    .dialog.success {
      border-top: 4px solid #27ae60;
    }

    .dialog.warning {
      border-top: 4px solid #f39c12;
    }

    .dialog.error {
      border-top: 4px solid #e74c3c;
    }

    .dialog h3 {
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .dialog p {
      margin-bottom: 12px;
      line-height: 1.6;
    }

    .dialog ul {
      margin: 10px 0 10px 20px;
    }

    .dialog li {
      margin-bottom: 5px;
    }

    .dialog .highlight {
      background: #fff3cd;
      padding: 12px 15px;
      border-radius: 6px;
      margin: 15px 0;
      font-size: 0.95em;
    }

    .dialog .highlight.green {
      background: #d4edda;
    }

    .dialog .btn-row {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      justify-content: flex-end;
    }

    /* Result panel */
    .result-panel {
      display: none;
      background: #eafaf1;
      border-left: 4px solid #27ae60;
      padding: 20px;
      border-radius: 0 8px 8px 0;
      margin-bottom: 20px;
    }

    .result-panel.show {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    .result-panel h3 {
      color: #27ae60;
      margin-bottom: 10px;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Navigation */
    .nav-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #dee2e6;
    }

    .btn {
      padding: 10px 20px;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      display: inline-block;
      border: none;
      font-size: 1em;
    }

    .btn-primary {
      background: #d35400;
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: #ba4a00;
    }

    .btn-primary:disabled {
      background: #bdc3c7;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: #ecf0f1;
      color: #666;
    }

    .btn-secondary:hover {
      background: #bdc3c7;
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>Tutorial 4: Handling Overdispersion</h1>
      <p>Step 2: Choose the Link Function</p>
    </div>
  </header>

  <div class="container">
    <!-- Progress -->
    <div class="progress-container">
      <div class="progress-bar">
        <div class="progress-fill"></div>
        <div class="step-dot completed">&#10003;</div>
        <div class="step-dot current">2</div>
        <div class="step-dot">3</div>
        <div class="step-dot">4</div>
        <div class="step-dot">5</div>
        <div class="step-dot">6</div>
      </div>
    </div>

    <!-- Context: Same link as Poisson -->
    <div class="context-panel">
      <h4>Same Link Function as Poisson</h4>
      <p>
        The link function choice is <strong>the same</strong> for Negative Binomial as for Poisson.
        Both model counts, so both need a link that ensures positive predictions.
        The key difference between the models is the <em>distribution</em>, not the link.
      </p>
    </div>

    <!-- Instruction -->
    <div class="instruction-panel">
      <h3>Step 2: Select the Link Function</h3>
      <p>Which function should map the linear predictor to expected counts?</p>
      <p style="font-size: 0.9em; color: #666;">
        <strong>Hint:</strong> We need g() such that g<sup>-1</sup>(X&beta;) is always positive.
      </p>
    </div>

    <!-- Link options -->
    <div class="link-options">
      <div class="link-card" data-link="log">
        <div class="link-name">Log Link</div>
        <div class="link-formula">g(&mu;) = ln(&mu;)</div>
        <p class="link-desc">Linear predictor maps to log of expected count. Ensures &mu; > 0.</p>
      </div>

      <div class="link-card" data-link="sqrt">
        <div class="link-name">Square Root Link</div>
        <div class="link-formula">g(&mu;) = &radic;&mu;</div>
        <p class="link-desc">Historically used for count data. Less interpretable coefficients.</p>
      </div>

      <div class="link-card" data-link="identity">
        <div class="link-name">Identity Link</div>
        <div class="link-formula">g(&mu;) = &mu;</div>
        <p class="link-desc">Direct mapping - linear predictor equals expected value.</p>
      </div>

      <div class="link-card" data-link="logit">
        <div class="link-name">Logit Link</div>
        <div class="link-formula">g(&mu;) = ln(&mu;/(1-&mu;))</div>
        <p class="link-desc">Maps to log-odds. Used for probabilities.</p>
      </div>
    </div>

    <!-- Result panel (shown after correct selection) -->
    <div class="result-panel" id="resultPanel">
      <h3>Link Function Selected: Log</h3>
      <p>With the <strong>log link</strong>, your model equation is:</p>
      <p style="font-family: 'Times New Roman', serif; font-size: 1.2em; background: white; padding: 12px 20px; border-radius: 6px; display: inline-block;">
        ln(E[cnt]) = &beta;<sub>0</sub> + &beta;<sub>1</sub>&middot;temp + &beta;<sub>2</sub>&middot;hum + &beta;<sub>3</sub>&middot;windspeed + ...
      </p>
      <p style="margin-top: 15px; color: #666;">
        The log link is identical for Poisson and Negative Binomial. The difference will be in the distribution (variance function).
      </p>
    </div>

    <!-- Navigation -->
    <div class="nav-buttons">
      <a href="systematic.html" class="btn btn-secondary">&larr; Back to Systematic</a>
      <button class="btn btn-primary" id="continueBtn" disabled>Continue to Distribution &rarr;</button>
    </div>
  </div>

  <!-- Dialog for Log (correct) -->
  <div class="dialog-overlay" id="logDialog">
    <div class="dialog success">
      <h3>&#10004; Correct! Log link is the standard choice.</h3>
      <p>
        The <strong>log link</strong> is the canonical link for both Poisson and Negative Binomial regression:
      </p>
      <ul>
        <li><strong>Positive predictions:</strong> Since &mu; = exp(X&beta;), predictions are always > 0</li>
        <li><strong>Multiplicative interpretation:</strong> exp(&beta;) gives rate ratios</li>
        <li><strong>Natural for count processes:</strong> Counts often grow multiplicatively with predictors</li>
      </ul>
      <div class="highlight green">
        <strong>Key insight:</strong> The link function is the same for Poisson and Negative Binomial.
        Both model counts, so both need the log link to ensure positive predictions.
        The difference is in the <em>variance function</em>, not the link.
      </div>
      <div class="btn-row">
        <button class="btn btn-primary" onclick="confirmLog()">Continue with Log Link</button>
      </div>
    </div>
  </div>

  <!-- Dialog for Sqrt (semi-valid) -->
  <div class="dialog-overlay" id="sqrtDialog">
    <div class="dialog warning">
      <h3>&#9888; Historically used, but not recommended today.</h3>
      <p>
        The <strong>square root link</strong> was sometimes used for count data:
      </p>
      <ul>
        <li><strong>Variance stabilising:</strong> For Poisson data, sqrt transform stabilises variance</li>
        <li><strong>Historical usage:</strong> Common before GLMs were well-understood</li>
        <li><strong>Less interpretable:</strong> Coefficients don't have a natural rate ratio interpretation</li>
      </ul>
      <div class="highlight">
        <strong>Modern practice:</strong> The log link is strongly preferred because exp(&beta;) gives
        interpretable rate ratios. Try selecting <strong>Log Link</strong> instead.
      </div>
      <div class="btn-row">
        <button class="btn btn-secondary" onclick="closeDialog('sqrtDialog')">Try Another Option</button>
      </div>
    </div>
  </div>

  <!-- Dialog for Identity (wrong) -->
  <div class="dialog-overlay" id="identityDialog">
    <div class="dialog error">
      <h3>&#10060; Not appropriate for count data!</h3>
      <p>
        The <strong>identity link</strong> is problematic for counts:
      </p>
      <ul>
        <li><strong>Negative predictions:</strong> If X&beta; < 0, we predict negative counts!</li>
        <li><strong>No natural lower bound:</strong> Counts must be &ge; 0, but &mu; = X&beta; can be anything</li>
        <li><strong>Works for Gaussian:</strong> Identity is appropriate when the response can be any real number</li>
      </ul>
      <div class="highlight">
        <strong>Example:</strong> With &beta;<sub>0</sub> = 100 and a large negative coefficient on temperature,
        cold days could predict -50 bike rentals. That's impossible!
      </div>
      <div class="btn-row">
        <button class="btn btn-secondary" onclick="closeDialog('identityDialog')">Try Another Option</button>
      </div>
    </div>
  </div>

  <!-- Dialog for Logit (wrong) -->
  <div class="dialog-overlay" id="logitDialog">
    <div class="dialog error">
      <h3>&#10060; Wrong data type - logit is for probabilities!</h3>
      <p>
        The <strong>logit link</strong> is designed for binary/proportion outcomes:
      </p>
      <ul>
        <li><strong>Bounded output:</strong> Logit<sup>-1</sup>(x) is always between 0 and 1</li>
        <li><strong>For probabilities:</strong> Perfect for Tutorial 2 (heart disease risk)</li>
        <li><strong>Not for counts:</strong> We need outputs > 1 (thousands of bike rentals!)</li>
      </ul>
      <div class="highlight">
        <strong>Data type mismatch:</strong> Logit constrains output to [0,1].
        Our bike rentals range from 22 to 8,714 - way outside this range!
      </div>
      <div class="btn-row">
        <button class="btn btn-secondary" onclick="closeDialog('logitDialog')">Try Another Option</button>
      </div>
    </div>
  </div>

  <script>
    let selectedLink = null;
    const cards = document.querySelectorAll('.link-card');

    cards.forEach(card => {
      card.addEventListener('click', () => {
        if (selectedLink === 'log') return; // Already confirmed

        const link = card.dataset.link;

        // Reset all cards
        cards.forEach(c => c.classList.remove('selected-correct', 'selected-wrong', 'selected-semi'));

        // Style and show dialog
        switch(link) {
          case 'log':
            card.classList.add('selected-correct');
            showDialog('logDialog');
            break;
          case 'sqrt':
            card.classList.add('selected-semi');
            showDialog('sqrtDialog');
            break;
          case 'identity':
            card.classList.add('selected-wrong');
            showDialog('identityDialog');
            break;
          case 'logit':
            card.classList.add('selected-wrong');
            showDialog('logitDialog');
            break;
        }
      });
    });

    function showDialog(dialogId) {
      document.getElementById(dialogId).classList.add('show');
    }

    function closeDialog(dialogId) {
      document.getElementById(dialogId).classList.remove('show');
      // Clear selection styling
      if (selectedLink !== 'log') {
        cards.forEach(c => c.classList.remove('selected-correct', 'selected-wrong', 'selected-semi'));
      }
    }

    function confirmLog() {
      selectedLink = 'log';
      closeDialog('logDialog');

      // Show result panel and enable continue
      document.getElementById('resultPanel').classList.add('show');
      document.getElementById('continueBtn').disabled = false;

      // Dim other cards
      cards.forEach(c => {
        if (c.dataset.link !== 'log') {
          c.classList.add('dimmed');
        }
      });
    }

    // Close dialog on overlay click
    document.querySelectorAll('.dialog-overlay').forEach(overlay => {
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          closeDialog(overlay.id);
        }
      });
    });

    document.getElementById('continueBtn').addEventListener('click', () => {
      window.location.href = 'distribution.html';
    });
  </script>

  <script src="../../js/feedback.js"></script>
</body>
</html>
