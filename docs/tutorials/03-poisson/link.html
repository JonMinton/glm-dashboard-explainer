<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GLM Tutorial: Choose the Link Function for Counts</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #f8f9fa;
      color: #333;
      line-height: 1.6;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%);
      color: white;
      padding: 20px;
      margin-bottom: 20px;
    }

    header h1 {
      font-size: 1.5em;
      margin-bottom: 5px;
    }

    header p {
      opacity: 0.9;
      font-size: 0.95em;
    }

    /* Progress indicator */
    .progress-indicator {
      display: flex;
      align-items: center;
      gap: 10px;
      background: white;
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .progress-step {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9em;
    }

    .progress-step .dot {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75em;
      font-weight: 600;
    }

    .progress-step.completed .dot {
      background: #8e44ad;
      color: white;
    }

    .progress-step.current .dot {
      background: #9b59b6;
      color: white;
    }

    .progress-step.pending .dot {
      background: #e0e0e0;
      color: #666;
    }

    .progress-connector {
      flex: 1;
      height: 2px;
      background: #e0e0e0;
    }

    .progress-connector.completed {
      background: #8e44ad;
    }

    /* Context panel - shows what we've built so far */
    .context-panel {
      background: #f9f3fc;
      border-left: 4px solid #9b59b6;
      padding: 15px 20px;
      border-radius: 0 8px 8px 0;
      margin-bottom: 20px;
    }

    .context-panel h3 {
      font-size: 0.9em;
      color: #8e44ad;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .equation-display {
      font-size: 1.1em;
      background: white;
      padding: 12px 20px;
      border-radius: 6px;
      display: inline-block;
    }

    .equation-display .unknown {
      background: #fff3cd;
      padding: 2px 8px;
      border-radius: 4px;
      color: #856404;
      font-weight: bold;
    }

    /* Key constraint panel */
    .constraint-panel {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 15px 20px;
      border-radius: 0 8px 8px 0;
      margin-bottom: 20px;
    }

    .constraint-panel h4 {
      color: #856404;
      margin-bottom: 8px;
    }

    .constraint-panel p {
      color: #856404;
      font-size: 0.95em;
    }

    .constraint-panel .math-display {
      background: white;
      padding: 10px 15px;
      border-radius: 6px;
      display: inline-block;
      margin: 10px 0;
    }

    /* Instruction panel */
    .instruction-panel {
      background: #f3e8f9;
      border-left: 4px solid #9b59b6;
      padding: 15px 20px;
      border-radius: 0 8px 8px 0;
      margin-bottom: 25px;
    }

    .instruction-panel h2 {
      color: #8e44ad;
      margin-bottom: 8px;
      font-size: 1.2em;
    }

    .instruction-panel p {
      margin-bottom: 8px;
    }

    /* Link function cards */
    .link-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
    }

    .link-card {
      background: white;
      border: 3px solid #dee2e6;
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
    }

    .link-card:hover:not(.dimmed):not(.selected) {
      border-color: #9b59b6;
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.1);
    }

    .link-card.dimmed {
      opacity: 0.4;
      filter: grayscale(40%);
      pointer-events: none;
    }

    .link-card.selected-correct {
      border-color: #27ae60;
      background: #f0fff4;
    }

    .link-card.selected-semi {
      border-color: #f39c12;
      background: #fffbf0;
    }

    .link-card.selected-wrong {
      animation: shake 0.4s ease-in-out;
      border-color: #e74c3c;
      background: #fdf2f2;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-8px); }
      75% { transform: translateX(8px); }
    }

    .link-card h3 {
      font-size: 1.1em;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .link-card .formula {
      font-size: 1.1em;
      background: #f8f9fa;
      padding: 8px 12px;
      border-radius: 4px;
      margin: 10px 0;
      text-align: center;
    }

    .link-card .description {
      font-size: 0.85em;
      color: #666;
    }

    .link-card .use-case {
      font-size: 0.8em;
      color: #888;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #eee;
    }

    /* Dialog overlay */
    .dialog-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 100;
      align-items: center;
      justify-content: center;
      overflow-y: auto;
    }

    .dialog-overlay.show {
      display: flex;
    }

    .dialog {
      background: white;
      border-radius: 12px;
      padding: 25px;
      max-width: 600px;
      margin: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      max-height: 90vh;
      overflow-y: auto;
    }

    .dialog.warning {
      border-top: 4px solid #f39c12;
    }

    .dialog.error {
      border-top: 4px solid #e74c3c;
    }

    .dialog.success {
      border-top: 4px solid #27ae60;
    }

    .dialog h3 {
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .dialog p {
      margin-bottom: 12px;
      line-height: 1.6;
    }

    .dialog .highlight {
      background: #fff3cd;
      padding: 10px 15px;
      border-radius: 6px;
      margin: 15px 0;
      font-size: 0.95em;
    }

    .dialog .highlight.green {
      background: #d4edda;
    }

    .dialog .btn-row {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      justify-content: flex-end;
    }

    .dialog ul {
      margin: 10px 0 10px 20px;
    }

    .dialog li {
      margin-bottom: 5px;
    }

    .dialog .history-box {
      background: #f8f9fa;
      border-left: 3px solid #6c757d;
      padding: 12px 15px;
      margin: 15px 0;
      font-size: 0.9em;
    }

    .dialog .history-box h4 {
      color: #495057;
      margin-bottom: 8px;
      font-size: 0.95em;
    }

    /* Result display */
    .result-panel {
      display: none;
      background: #f0fff4;
      border-left: 4px solid #27ae60;
      padding: 20px;
      border-radius: 0 8px 8px 0;
      margin-bottom: 20px;
    }

    .result-panel.show {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    .result-panel h3 {
      color: #27ae60;
      margin-bottom: 10px;
    }

    .result-equation {
      font-size: 1.2em;
      background: white;
      padding: 15px 25px;
      border-radius: 6px;
      display: inline-block;
      margin: 10px 0;
    }

    .interpretation-box {
      background: #f3e8f9;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
    }

    .interpretation-box h4 {
      color: #8e44ad;
      margin-bottom: 10px;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Navigation */
    .nav-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 25px;
      padding-top: 20px;
      border-top: 1px solid #dee2e6;
    }

    .btn {
      padding: 12px 24px;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      display: inline-block;
      border: none;
      font-size: 1em;
    }

    .btn-primary {
      background: #8e44ad;
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: #7d3c98;
    }

    .btn-primary:disabled {
      background: #bdc3c7;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: #ecf0f1;
      color: #666;
    }

    .btn-secondary:hover {
      background: #bdc3c7;
    }

    .btn-warning {
      background: #f39c12;
      color: white;
    }

    .btn-warning:hover {
      background: #e67e22;
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>Tutorial 3: The Link Function for Count Data</h1>
      <p>Choose how to connect your predictors to the expected bike rental count</p>
    </div>
  </header>

  <div class="container">
    <!-- Progress -->
    <div class="progress-indicator">
      <div class="progress-step completed">
        <span class="dot">&#10003;</span>
        <span>Systematic</span>
      </div>
      <div class="progress-connector completed"></div>
      <div class="progress-step current">
        <span class="dot">2</span>
        <span>Link Function</span>
      </div>
      <div class="progress-connector"></div>
      <div class="progress-step pending">
        <span class="dot">3</span>
        <span>Distribution</span>
      </div>
    </div>

    <!-- Context: what we've built -->
    <div class="context-panel">
      <h3>Your model so far</h3>
      <div class="equation-display">
        E[RentalCount] = <span class="unknown">g(?)</span>(1, Temperature, Humidity, WindSpeed, WorkingDay, Weather)
      </div>
      <p style="margin-top: 10px; font-size: 0.9em; color: #666;">
        The link function <strong>g()</strong> determines how the linear combination of predictors relates to the <em>expected count</em> of rentals.
      </p>
    </div>

    <!-- Key constraint -->
    <div class="constraint-panel">
      <h4>The Key Constraint</h4>
      <p>
        We're predicting a <strong>count</strong>. This means our predictions must be non-negative:
      </p>
      <div class="math-display">
        $\mu = E[\text{Count}] \geq 0$
      </div>
      <p>
        The link function must map from the unbounded linear predictor $\eta = \beta_0 + \beta_1 X_1 + \ldots$ (which can be any real number) to a strictly positive count.
      </p>
    </div>

    <!-- Instruction -->
    <div class="instruction-panel">
      <h2>Choose the Link Function</h2>
      <p>For predicting <strong>bike rental counts</strong> (non-negative integers), which link function is most appropriate?</p>
      <p style="font-size: 0.9em; color: #666;"><em>Click on a card to select it.</em></p>
    </div>

    <!-- Link function options -->
    <div class="link-options">
      <!-- Log (correct) -->
      <div class="link-card" data-link="log">
        <h3>Log</h3>
        <div class="formula">$g(\mu) = \ln(\mu)$</div>
        <p class="description">
          Ensures predictions are positive. Models multiplicative effects on the rate.
        </p>
        <p class="use-case">
          <strong>Use when:</strong> Response must be strictly positive (counts, rates)
        </p>
      </div>

      <!-- Sqrt (semi-valid) -->
      <div class="link-card" data-link="sqrt">
        <h3>Square Root</h3>
        <div class="formula">$g(\mu) = \sqrt{\mu}$</div>
        <p class="description">
          Variance-stabilizing transformation. Less interpretable coefficients.
        </p>
        <p class="use-case">
          <strong>Use when:</strong> Historically for variance stabilization
        </p>
      </div>

      <!-- Identity (wrong) -->
      <div class="link-card" data-link="identity">
        <h3>Identity</h3>
        <div class="formula">$g(\mu) = \mu$</div>
        <p class="description">
          No transformation. Predictions are directly on the response scale.
        </p>
        <p class="use-case">
          <strong>Use when:</strong> Response can be any real number
        </p>
      </div>

      <!-- Logit (wrong) -->
      <div class="link-card" data-link="logit">
        <h3>Logit</h3>
        <div class="formula">$g(\mu) = \ln\left(\frac{\mu}{1-\mu}\right)$</div>
        <p class="description">
          The "log-odds" transformation. Maps probabilities (0-1) to the real line.
        </p>
        <p class="use-case">
          <strong>Use when:</strong> Response is a probability or binary
        </p>
      </div>
    </div>

    <!-- Result panel (shown after correct selection) -->
    <div class="result-panel" id="resultPanel">
      <h3>Link Function Selected: Log</h3>
      <p>With the <strong>log link</strong>, your model equation becomes:</p>
      <div class="result-equation">
        $\ln(\mu) = \beta_0 + \beta_1 \cdot \text{Temp} + \beta_2 \cdot \text{Hum} + \beta_3 \cdot \text{Wind} + \beta_4 \cdot \text{Work} + \beta_5 \cdot \text{Weather}$
      </div>
      <div class="interpretation-box">
        <h4>What the coefficients mean</h4>
        <p>
          With the log link, the coefficients give <strong>rate ratios</strong>:
        </p>
        <ul style="margin: 10px 0 0 20px;">
          <li>$e^{\beta}$ gives the <strong>multiplicative effect</strong> on the expected count</li>
          <li>$e^{\beta} = 1.5$ means 50% more rentals for a one-unit increase</li>
          <li>$e^{\beta} = 0.8$ means 20% fewer rentals for a one-unit increase</li>
        </ul>
      </div>
    </div>

    <!-- Navigation -->
    <div class="nav-buttons">
      <a href="systematic.html" class="btn btn-secondary">&larr; Back to Variables</a>
      <button class="btn btn-primary" id="continueBtn" disabled>Continue to Distribution &rarr;</button>
    </div>
  </div>

  <!-- Dialog for log (correct) -->
  <div class="dialog-overlay" id="logDialog">
    <div class="dialog success">
      <h3>&#10004; Correct Choice!</h3>
      <p>
        The <strong>log link</strong> is the canonical choice for count data, giving us <strong>Poisson regression</strong> (when combined with the Poisson distribution).
      </p>
      <p>
        The log function ensures predictions are always positive:
      </p>
      <div class="highlight green">
        $\ln(\mu) = \eta \quad \Rightarrow \quad \mu = e^\eta > 0$
        <br><br>
        Since $e^x > 0$ for all real $x$, our predicted counts can never be negative!
      </div>
      <p>
        <strong>Why log dominates for counts:</strong>
      </p>
      <ul>
        <li><strong>Rate ratio interpretation:</strong> $e^\beta$ gives the multiplicative effect on the rate</li>
        <li><strong>Canonical link:</strong> Natural pairing with Poisson distribution in GLM theory</li>
        <li><strong>Guarantees positivity:</strong> Can't predict -50 bike rentals</li>
        <li><strong>Multiplicative effects:</strong> Many count processes have multiplicative relationships</li>
      </ul>
      <div class="btn-row">
        <button class="btn btn-primary" onclick="confirmLog()">Continue with Log Link</button>
      </div>
    </div>
  </div>

  <!-- Dialog for sqrt (semi-valid with historical context) -->
  <div class="dialog-overlay" id="sqrtDialog">
    <div class="dialog warning">
      <h3>&#9888; Valid, But Not Preferred Today</h3>
      <p>
        The <strong>square root link</strong> is mathematically valid for count data - it also ensures positive predictions. However, it's rarely used today.
      </p>

      <div class="history-box">
        <h4>Historical Context</h4>
        <p>
          <strong>Pre-GLM era (before 1970s):</strong> The square root was used as a "variance-stabilizing transformation" for count data.
        </p>
        <p style="margin-top: 8px;">
          <strong>Why sqrt was used:</strong> For Poisson data, Var$(Y) = \mu$, so variance increases with the mean. The square root transformation was thought to "stabilize" this variance.
        </p>
        <p style="margin-top: 8px;">
          <strong>Why log won:</strong> GLM theory showed that the log link is the "canonical" link for Poisson, and the variance issue is handled by the model itself. Plus, log coefficients have cleaner interpretation (rate ratios).
        </p>
      </div>

      <div class="highlight">
        <strong>The interpretation problem:</strong>
        <br><br>
        With sqrt link: $\sqrt{\mu} = \beta_0 + \beta_1 X$
        <br>
        What does $\beta_1$ mean? It's the change in $\sqrt{\mu}$ per unit change in $X$ - not intuitive!
        <br><br>
        With log link: $e^{\beta_1}$ is the rate ratio - much more interpretable.
      </div>

      <p style="font-size: 0.9em; color: #666;">
        <em>For this tutorial, use the log link - it's the modern standard with better interpretation.</em>
      </p>
      <div class="btn-row">
        <button class="btn btn-secondary" onclick="closeDialog('sqrtDialog')">Try Another Option</button>
      </div>
    </div>
  </div>

  <!-- Dialog for identity (wrong) -->
  <div class="dialog-overlay" id="identityDialog">
    <div class="dialog error">
      <h3>&#10060; Can Predict Negative Counts</h3>
      <p>
        The <strong>identity link</strong> doesn't constrain predictions to be positive:
      </p>
      <div class="highlight">
        $\mu = \beta_0 + \beta_1 \cdot \text{Temp} + \beta_2 \cdot \text{Humidity} + \ldots$
      </div>
      <p>
        <strong>The problem:</strong> Linear combinations can produce any real number:
      </p>
      <ul>
        <li>Prediction: -247 bike rentals (impossible!)</li>
        <li>Counts must be 0, 1, 2, 3, ... - never negative</li>
      </ul>
      <p>
        The identity link is appropriate for continuous responses that can be any real number (like temperature or weight change), but not for counts.
      </p>
      <div class="btn-row">
        <button class="btn btn-secondary" onclick="closeDialog('identityDialog')">Try Another Option</button>
      </div>
    </div>
  </div>

  <!-- Dialog for logit (wrong) -->
  <div class="dialog-overlay" id="logitDialog">
    <div class="dialog error">
      <h3>&#10060; Wrong Domain</h3>
      <p>
        The <strong>logit link</strong> is designed for <strong>probabilities</strong>, not counts:
      </p>
      <div class="highlight">
        $\text{logit}(\mu) = \ln\left(\frac{\mu}{1-\mu}\right)$
        <br><br>
        This requires $0 < \mu < 1$ - it only makes sense for probabilities!
      </div>
      <p>
        <strong>The problems:</strong>
      </p>
      <ul>
        <li>Bike rental counts can be 22, 4548, 8714... not between 0 and 1</li>
        <li>$\ln(\frac{4548}{1-4548})$ is undefined (negative number in denominator)</li>
        <li>Logit is for binary outcomes (Tutorial 2), not counts</li>
      </ul>
      <p>
        Remember: Tutorial 2 used logit for heart disease (yes/no). This tutorial has counts (0, 1, 2, ..., thousands).
      </p>
      <div class="btn-row">
        <button class="btn btn-secondary" onclick="closeDialog('logitDialog')">Try Another Option</button>
      </div>
    </div>
  </div>

  <script>
    // State
    let selectedLink = null;

    // Link card click handlers
    document.querySelectorAll('.link-card').forEach(card => {
      card.addEventListener('click', () => {
        const link = card.dataset.link;
        handleLinkSelection(link, card);
      });
    });

    function handleLinkSelection(link, card) {
      // Don't process if already confirmed
      if (selectedLink === 'log') return;

      // Remove previous selection styling
      document.querySelectorAll('.link-card').forEach(c => {
        c.classList.remove('selected-correct', 'selected-semi', 'selected-wrong');
      });

      switch(link) {
        case 'log':
          // Correct choice
          card.classList.add('selected-correct');
          showDialog('logDialog');
          break;

        case 'sqrt':
          // Semi-valid - show historical context
          card.classList.add('selected-semi');
          showDialog('sqrtDialog');
          break;

        case 'identity':
          // Wrong - can predict negative counts
          card.classList.add('selected-wrong');
          showDialog('identityDialog');
          break;

        case 'logit':
          // Wrong - for probabilities, not counts
          card.classList.add('selected-wrong');
          showDialog('logitDialog');
          break;
      }
    }

    function confirmLog() {
      // User confirmed log link selection
      selectedLink = 'log';
      closeDialog('logDialog');

      // Show result panel and enable continue
      document.getElementById('resultPanel').classList.add('show');
      document.getElementById('continueBtn').disabled = false;

      // Dim other cards
      document.querySelectorAll('.link-card:not([data-link="log"])').forEach(c => {
        c.classList.add('dimmed');
      });

      // Re-render KaTeX in result panel
      renderMathInElement(document.getElementById('resultPanel'), {
        delimiters: [
          {left: '$$', right: '$$', display: true},
          {left: '$', right: '$', display: false}
        ]
      });
    }

    function showDialog(dialogId) {
      const dialog = document.getElementById(dialogId);
      dialog.classList.add('show');
      // Render KaTeX in dialog
      renderMathInElement(dialog, {
        delimiters: [
          {left: '$$', right: '$$', display: true},
          {left: '$', right: '$', display: false}
        ]
      });
    }

    function closeDialog(dialogId) {
      document.getElementById(dialogId).classList.remove('show');

      // Clear selection styling if not confirmed
      if (selectedLink !== 'log') {
        document.querySelectorAll('.link-card').forEach(c => {
          c.classList.remove('selected-correct', 'selected-semi', 'selected-wrong');
        });
      }
    }

    // Close dialogs on overlay click
    document.querySelectorAll('.dialog-overlay').forEach(overlay => {
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          closeDialog(overlay.id);
        }
      });
    });

    // Continue button
    document.getElementById('continueBtn').addEventListener('click', () => {
      window.location.href = 'distribution.html';
    });

    // Initial KaTeX render
    document.addEventListener('DOMContentLoaded', () => {
      renderMathInElement(document.body, {
        delimiters: [
          {left: '$$', right: '$$', display: true},
          {left: '$', right: '$', display: false}
        ]
      });
    });
  </script>

  <script src="../../js/feedback.js"></script>
</body>
</html>
